# Исправление проблемы зависания запроса из-за Celery

## Проблема

Запрос отправляется на Celery worker, но не выполняется. В логах видно:
```
Query 40: Running query on a Celery worker
```

Но нет результатов и запрос зависает в статусе "pending".

## Причина

Superset пытается выполнить запрос асинхронно через Celery, но:
1. Celery worker не запущен
2. Celery не настроен правильно
3. Redis не доступен для Celery

## Решения

### Решение 1: Отключить асинхронные запросы для Database (БЫСТРОЕ РЕШЕНИЕ)

1. Откройте Superset → **Data** → **Databases**
2. Найдите **"Ubidex Events DB"** → нажмите **Edit** (✏️)
3. Найдите раздел **"Query Execution Options"** или **"Advanced"**
4. **Отключите** ✅ **"Asynchronous query execution"** (снимите галочку)
5. Нажмите **Save**

Теперь запросы будут выполняться синхронно (медленнее, но надежнее).

### Решение 2: Использовать упрощенную версию SQL запроса

Используйте файл `split_test_analysis_simple.sql`:
- Убраны сложные вычисления (PERCENT_RANK, процентили)
- Упрощена логика определения групп
- Обязательно добавлен фильтр по дате

**Важно:** В SQL запросе обязательно раскомментируйте фильтр по дате:
```sql
AND ue.event_date >= CURRENT_DATE - INTERVAL '30 days'  -- Последние 30 дней
```

### Решение 3: Настроить Celery (для опытных пользователей)

Если нужно использовать асинхронные запросы:

1. **Проверьте Redis:**
   - Убедитесь, что Redis доступен
   - Проверьте переменные окружения: `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`

2. **Запустите Celery worker:**
   ```bash
   celery --app=superset.tasks.celery_app:app worker --pool=prefork --max-tasks-per-child=1
   ```

3. **Проверьте логи Celery worker** на наличие ошибок

### Решение 4: Использовать синхронное выполнение через SQL Lab

1. Откройте **SQL Lab**
2. Вставьте SQL запрос
3. **Не используйте** "Run Async" - используйте обычный "Run"
4. Запрос выполнится синхронно (может быть медленнее, но надежнее)

## Рекомендуемый порядок действий

1. **СРОЧНО:** Отключите асинхронные запросы в настройках Database (Решение 1)
2. **Добавьте фильтр по дате** в SQL запрос (обязательно!)
3. **Используйте упрощенную версию** SQL (`split_test_analysis_simple.sql`)
4. **Проверьте:** Запрос должен выполняться

## Проверка результата

После отключения асинхронных запросов:

1. Запрос должен начать выполняться сразу
2. Таймер должен запуститься
3. Результаты должны появиться через несколько секунд/минут

## Если проблема сохраняется

1. Убедитесь, что фильтр по дате добавлен в SQL
2. Уменьшите период данных (7 дней вместо 30)
3. Проверьте, что индексы созданы
4. Используйте самый простой SQL запрос без CTE

