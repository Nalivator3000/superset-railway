# Исправление распределения групп сплит-теста (25/75 вместо 50/50)

## Проблема

Распределение получается примерно 50/50, а должно быть 25% Control / 75% Test.

## Причина

Если `external_user_id` содержит **только цифры** (0-9), то:
- Control: 0-7 = 8 символов из 10 = **80%** (не 25%!)
- Test: 8-9 = 2 символа из 10 = **20%** (не 75%!)

Если `external_user_id` содержит **цифры и буквы** (0-9a-z = 36 символов), то:
- Control: 0-7 = 8 символов из 36 = **~22%** (близко к 25%)
- Test: 8-9a-z = 28 символов из 36 = **~78%** (близко к 75%)

## Решение

### Вариант 1: Использовать хеш от user_id (РЕКОМЕНДУЕТСЯ)

Если user_id содержит только цифры, используйте хеш для равномерного распределения:

```sql
-- Используем остаток от деления хеша на 4 для получения 25/75
CASE 
    WHEN ABS(HASHTEXT(ue.external_user_id)) % 4 < 1  -- 0 = 25%
    THEN 'Control'
    ELSE 'Test'  -- 1, 2, 3 = 75%
END as test_group
```

### Вариант 2: Использовать другой диапазон символов

Если user_id содержит только цифры, используйте:
- Control: 0-2 (3 символа из 10 = 30%, близко к 25%)
- Test: 3-9 (7 символов из 10 = 70%, близко к 75%)

Или:
- Control: 0-1 (2 символа из 10 = 20%, близко к 25%)
- Test: 2-9 (8 символов из 10 = 80%, близко к 75%)

### Вариант 3: Использовать предпоследний символ

Если последний символ дает неравномерное распределение, попробуйте предпоследний:
- char_position = 2

## Проверка распределения

Сначала выполните диагностический запрос `check_user_id_distribution.sql` чтобы понять, какие символы реально используются в user_id.

